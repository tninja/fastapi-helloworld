<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>一束光，一句话: 安慰经文助手</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", sans-serif;
      margin: 2rem auto;
      max-width: 760px;
      padding: 0 1rem;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    h1 { margin-bottom: .25rem; text-shadow: 0 1px 2px rgba(255,255,255,0.7); }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 16px 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); background-color: rgba(255, 255, 255, 0.9); }
    label { display:block; font-weight:600; margin:.5rem 0 .25rem; }
    input, textarea, select { width: 100%; padding: .6rem .75rem; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; }
    button { cursor:pointer; padding: .7rem 1rem; border-radius: 999px; border: 0; background:#111827; color:#fff; font-weight:600; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:.75rem; align-items:center; }
    .muted { color:#6b7280; font-size:.9rem; text-shadow: 0 1px 2px rgba(255,255,255,0.7); }
    .passage { padding:.5rem .75rem; border-left:4px solid #11182710; background:#f9fafb; border-radius:8px; margin:.5rem 0; }
    .error { color:#b91c1c; font-weight:600; background-color: rgba(255, 255, 255, 0.85); padding: .5rem; border-radius: 8px; }
    pre { white-space:pre-wrap; word-break:break-word; }
    .footer { color:#374151; font-size:.85rem; margin-top:2rem; text-shadow: 0 1px 2px rgba(255,255,255,0.7); }
  </style>
</head>
<body>
  <h1 id="header1"></h1>
  <h2 id="header2"></h2>
  <div class="muted" id="intro"></div>

  <div class="card">
    <div class="row">
      <div style="flex-grow:1">
        <label for="language" id="langLabel"></label>
        <select id="language">
          <option value="zh" selected>中文</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label for="max_passages" id="passagesLabel"></label>
        <input type="number" id="max_passages" value="3" min="1" max="10" style="width: 60px;" />
      </div>
    </div>

    <label for="sit" id="situationLabel"></label>
    <textarea id="sit" rows="5"></textarea>

    <label for="guide" id="guidanceLabel"></label>
    <input id="guide" />

    <div class="row" style="margin-top:.75rem">
      <button id="go"></button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="result" class="card" style="display:none"></div>
  <div id="err" class="error"></div>

  <div class="footer" id="footer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_BASE = "https://fastapi-helloworld-od7w.onrender.com";

      const el = (id) => document.getElementById(id);
      const btn = el('go');
      const out = el('result');
      const err = el('err');
      const status = el('status');
      const langSelect = el('language');

      const translations = {
        zh: {
          title: "一束光，一句话: 安慰经文助手",
          header1: "一束光，一句话",
          header2: "安慰经文助手",
          intro: "输入你的处境，我们将给出相应经文参考、简短灵修与祷告。",
          langLabel: "语言",
          passagesLabel: "经文数",
          situationLabel: "处境描述",
          situationPlaceholder: "写下你正在经历的事，比如：项目延期、担心裁员、需要照顾孩子…",
          guidanceLabel: "额外引导 (可选)",
          guidancePlaceholder: "例如：请多引用诗篇；请避免旧约经文",
          buttonText: "获取安慰",
          statusGenerating: "生成中，请稍候 (约10秒)...",
          errorSituation: "请先填写处境描述。",
          errorRequestFailed: "请求失败：",
          footer: "前端托管在 GitHub Pages · 后端由 FastAPI (Render) 提供。为避免版权与版本差异，页面仅给出经文出处与极短摘句，请以你常用的译本核对上下文。",
          passagesTitle: "推荐经文",
          devotionalTitle: "灵修解读",
          prayerTitle: "祷告"
        },
        en: {
          title: "Comfort Scriptures: A Ray of Light, A Word of Grace",
          header1: "A Ray of Light, A Word of Grace",
          header2: "Comfort Scriptures Assistant",
          intro: "Describe your situation, and we will provide relevant scripture references, a short devotional, and a prayer.",
          langLabel: "Language",
          passagesLabel: "Passages",
          situationLabel: "Describe your situation",
          situationPlaceholder: "Write down what you are going through, e.g., project delays, fear of layoffs, taking care of children...",
          guidanceLabel: "Optional Guidance",
          guidancePlaceholder: "e.g., please quote more from Psalms; please avoid Old Testament verses",
          buttonText: "Get Comfort",
          statusGenerating: "Generating... this may take about 10 seconds.",
          errorSituation: "Please describe your situation first.",
          errorRequestFailed: "Request failed: ",
          footer: "Frontend hosted on GitHub Pages · Backend powered by FastAPI (Render). To avoid copyright and version differences, this page only provides scripture references and very short quotes. Please check the context in your preferred translation.",
          passagesTitle: "Recommended Passages",
          devotionalTitle: "Devotional",
          prayerTitle: "Prayer"
        }
      };

      function updateUI(lang) {
        const t = translations[lang];
        document.title = t.title;
        el('header1').textContent = t.header1;
        el('header2').textContent = t.header2;
        el('intro').textContent = t.intro;
        el('langLabel').textContent = t.langLabel;
        el('passagesLabel').textContent = t.passagesLabel;
        el('situationLabel').textContent = t.situationLabel;
        el('sit').placeholder = t.situationPlaceholder;
        el('guidanceLabel').textContent = t.guidanceLabel;
        el('guide').placeholder = t.guidancePlaceholder;
        btn.textContent = t.buttonText;
        el('footer').textContent = t.footer;
        document.documentElement.lang = lang.startsWith('zh') ? 'zh-CN' : 'en';
      }

      async function fetchComfort() {
        const lang = langSelect.value;
        const t = translations[lang];

        err.textContent = "";
        out.style.display = 'none';
        out.innerHTML = '';

        const body = {
          language: lang,
          situation: el('sit').value.trim(),
          guidance: el('guide').value.trim(),
          max_passages: parseInt(el('max_passages').value, 10) || 3
        };
        if (!body.situation) {
          err.textContent = t.errorSituation;
          return;
        }

        btn.disabled = true;
        status.textContent = t.statusGenerating;

        try {
          const res = await fetch(`${API_BASE}/comfort`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          const data = await res.json();
          renderResult(data, lang);
        } catch (e) {
          console.error(e);
          err.textContent = t.errorRequestFailed + (e.message || e);
          console.log('Fetch failed detail =>', e);
        } finally {
          btn.disabled = false;
          status.textContent = '';
        }
      }

      function renderResult(data, lang) {
        const t = translations[lang];
        const passages = data.passages || [];
        const devotional = data.devotional || '';
        const prayer = data.prayer || '';
        const disclaimer = data.disclaimer || '';

        const h = [];
        if (passages.length) {
          h.push(`<h2>${t.passagesTitle}</h2>`);
          passages.forEach(p => {
            const quote = p.short_quote ? ` · <em>${escapeHtml(p.short_quote)}</em>` : '';
            const reason = p.reason ? `<div class="muted">${escapeHtml(p.reason)}</div>` : '';
            const full_text = p.full_passage_text ? `<pre style="margin-top: .5rem;">${escapeHtml(p.full_passage_text)}</pre>` : '';
            h.push(`<div class="passage"><strong>${escapeHtml(p.ref)}</strong>${quote}${reason}${full_text}</div>`);
          });
        }
        if (devotional) {
          h.push(`<h2>${t.devotionalTitle}</h2>`);
          h.push(`<pre>${escapeHtml(devotional)}</pre>`);
        }
        if (prayer) {
          h.push(`<h2>${t.prayerTitle}</h2>`);
          h.push(`<pre>${escapeHtml(prayer)}</pre>`);
        }
        if (disclaimer) {
          h.push(`<div class="muted">${escapeHtml(disclaimer)}</div>`);
        }

        out.innerHTML = h.join('\n');
        out.style.display = 'block';
      }

      function escapeHtml(str){
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return String(str).replace(/[&<"']/g, s => map[s]);
      }

      btn.addEventListener('click', fetchComfort);
      langSelect.addEventListener('change', (e) => updateUI(e.target.value));

      // Initial UI setup
      updateUI(langSelect.value);
    });
  </script>
</body>
</html>
